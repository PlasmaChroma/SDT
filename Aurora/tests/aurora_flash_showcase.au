aurora { version: "1.0" }

globals {
  sr: 48000,
  block: 256,
  tempo: 124,
  tail_policy: fixed(2s)
}

outputs {
  stems_dir: "./renders/stems/",
  midi_dir: "./renders/midi/",
  mix_dir: "./renders/mix/",
  meta_dir: "./renders/meta/",
  master: "master.wav",
  render_json: "render.json"
}

bus SpaceFX {
  channels: 2,
  out: stem("fx_space"),
  graph: {
    nodes: [
      { id: "bus_in", type: mix },
      { id: "echo", type: delay, params: { time: 280ms, fb: 0.56, mix: 0.62, hicut: 6200Hz, locut: 180Hz, pingpong: true, mod_rate: 0.22Hz, mod_depth: 5ms } },
      { id: "rev", type: reverb_algo, params: { size: 0.84, decay: 5.5s, predelay: 18ms, mix: 0.38, width: 0.9, hicut: 7600Hz, locut: 120Hz } }
    ],
    connect: [
      { from: "bus_in", to: "echo.in" },
      { from: "echo", to: "rev.in" }
    ],
    io: { out: "rev" }
  }
}

patch NeonBass {
  mono: true,
  legato: true,
  retrig: never,
  voice_steal: highest,
  out: stem("neon_bass"),
  send: { bus: "SpaceFX", amount: -14dB },
  graph: {
    nodes: [
      { id: "osc", type: osc_saw_blep, params: { freq: 55Hz } },
      { id: "env", type: env_adsr, params: { a: 6ms, d: 220ms, s: 0.55, r: 480ms } },
      { id: "filt", type: svf, params: { mode: lp, cutoff: 320Hz, q: 0.9, drive: 3.2, drive_pos: post, slope: 24, keytrack: 0.8, env_amt: 1800Hz } },
      { id: "rm", type: ring_mod, params: { mode: unbalanced, shape: sine, freq: 24Hz, depth: 0.4, mix: 0.26, bias: 0.0 } },
      { id: "clip", type: softclip, params: { drive: 3.4, mix: 0.45, bias: 0.01 } },
      { id: "vca", type: vca, params: { gain: 1.0, cv: 1.0, curve: exp, curve_amt: 2.6 } },
      { id: "amp", type: gain, params: { gain: -10dB } }
    ],
    connect: [
      { from: "osc", to: "filt.in" },
      { from: "filt", to: "amp.in" },
      { from: "env.out", to: "vca.cv", rate: control, map: { type: set, min: 0.0, max: 1.0 } },
      { from: "env.out", to: "rm.mix", rate: control, map: { type: set, min: 0.08, max: 0.5 } },
      { from: "env.out", to: "clip.drive", rate: control, map: { type: set, min: 1.2, max: 5.6 } }
    ],
    io: { out: "amp" }
  }
}

patch CrystalLead {
  out: stem("crystal_lead"),
  send: { bus: "SpaceFX", amount: -10dB },
  binaural: { enabled: true, shift: 6Hz, mix: 0.6 },
  graph: {
    nodes: [
      { id: "osc1", type: osc_tri_blep, params: { freq: 220Hz } },
      { id: "osc2", type: osc_pulse_blep, params: { freq: 220Hz, pw: 0.36 } },
      { id: "env", type: env_ad, params: { a: 4ms, d: 360ms } },
      { id: "src", type: lfo, params: { shape: tri, rate: 0.6Hz, depth: 1.0, unipolar: true } },
      { id: "trig", type: lfo, params: { shape: square, rate: 7.5Hz, depth: 1.0, unipolar: true } },
      { id: "sh", type: cv_sample_hold, params: { threshold: 0.5, hysteresis: 0.03 } },
      { id: "cmp", type: cv_cmp, params: { threshold: 0.58, hysteresis: 0.04, high: 1.0, low: 0.0 } },
      { id: "lg", type: cv_logic, params: { op: xor, threshold: 0.5, high: 1.0, low: 0.0 } },
      { id: "mx", type: audio_mix, params: { gain: 1.2, mix: 0.72, bias: 0.0 } },
      { id: "filt", type: svf, params: { mode: bp, cutoff: 1300Hz, q: 1.1, drive: 2.1, slope: 12, keytrack: 0.45 } },
      { id: "rm", type: ring_mod_diode, params: { shape: tri, freq: 45Hz, depth: 0.8, mix: 0.35, bias: 0.0 } },
      { id: "vca", type: vca, params: { gain: 1.0, cv: 1.0, curve: log, curve_amount: 2.4 } },
      { id: "amp", type: gain, params: { gain: -13dB } }
    ],
    connect: [
      { from: "osc1", to: "filt.in" },
      { from: "osc2", to: "filt.in" },
      { from: "filt", to: "amp.in" },
      { from: "src.out", to: "sh.in" },
      { from: "trig.out", to: "sh.in2" },
      { from: "sh.out", to: "filt.cutoff", rate: control, map: { type: set, min: 520, max: 3600 } },
      { from: "sh.out", to: "cmp.in" },
      { from: "cmp.out", to: "lg.in" },
      { from: "trig.out", to: "lg.in2" },
      { from: "lg.out", to: "vca.cv", rate: control, map: { type: set, min: 0.06, max: 1.0 } },
      { from: "env.out", to: "rm.depth", rate: control, map: { type: set, min: 0.2, max: 1.2 } },
      { from: "env.out", to: "mx.mix", rate: control, map: { type: set, min: 0.25, max: 1.0 } }
    ],
    io: { out: "amp" }
  }
}

patch Sparks {
  out: stem("sparks"),
  send: { bus: "SpaceFX", amount: -8dB },
  graph: {
    nodes: [
      { id: "n", type: noise_white },
      { id: "f", type: biquad, params: { type: hp, freq: 2400Hz, q: 0.8, drive: 2.8, slope: 24 } },
      { id: "env", type: env_ad, params: { a: 1ms, d: 90ms } },
      { id: "vca", type: vca, params: { gain: 1.0, cv: 1.0, curve: exp, curve_amt: 1.8 } },
      { id: "amp", type: gain, params: { gain: -16dB } }
    ],
    connect: [
      { from: "n", to: "f.in" },
      { from: "f", to: "amp.in" },
      { from: "env.out", to: "vca.cv", rate: control, map: { type: set, min: 0.0, max: 1.0 } }
    ],
    io: { out: "amp" }
  }
}

score {
  section Lift at 0s dur 4s | xfade=120ms {
    play NeonBass { at: 0s, dur: 4s, vel: 0.92, pitch: [A1, A2] }
    play CrystalLead { at: 0s, dur: 4s, vel: 0.86, pitch: [A4, C5, E5, G5] }
    seq Sparks { at: 0s, dur: 4s, rate: 0.25beats, pattern: euclid(7,16,1), prob: 0.9, pick: cycle, pitch: [C6, D6, G6], jitter: 8ms, swing: 0.57, max: 420 }

    automate patch.NeonBass.filt.cutoff smooth { 0s: 260Hz, 2s: 520Hz, 4s: 340Hz }
    automate patch.NeonBass.rm.freq linear { 0s: 16Hz, 2s: 48Hz, 4s: 22Hz }
    automate patch.CrystalLead.osc1.binaural_shift smooth { 0s: 3, 2s: 11, 4s: 5 }
    automate patch.CrystalLead.osc1.binaural_mix linear { 0s: 0.25, 2s: 1.0, 4s: 0.45 }
  }

  section Burst at 4s dur 4s | xfade=140ms {
    play NeonBass { at: 4s, dur: 4s, vel: 0.98, pitch: [F1, F2] }
    play CrystalLead { at: 4s, dur: 4s, vel: 0.9, pitch: [F4, A4, C5, E5] }
    seq Sparks { at: 4s, dur: 4s, rate: 0.25beats, pattern: "x.xx.x.x.xx.x.x.", prob: 0.95, pick: cycle, pitch: [A5, C6, D6], jitter: 10ms, swing: 0.6, max: 460 }

    automate patch.NeonBass.filt.drive linear { 4s: 2.0, 6s: 5.6, 8s: 2.8 }
    automate patch.CrystalLead.rm.mix smooth { 4s: 0.12, 6s: 0.65, 8s: 0.22 }
    automate patch.CrystalLead.vca.curve_amt linear { 4s: 1.4, 6s: 3.2, 8s: 2.0 }
  }
}
